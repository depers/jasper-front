<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <link href="css/style.css" type="text/css" rel="stylesheet" />
    <link href="css/details.css" type="text/css" rel="stylesheet" />
    <link href="css/github.min.css" type="text/css" rel="stylesheet"/>
    <script src="js/jquery-3.6.4.js"></script>
    <script src="js/axios.js"></script>
    <script src="js/marked.umd.js"></script>
    <script src="js/highlight.min.js"></script>
    <link href="css/github-markdown-light.css" rel="stylesheet">
    <link href="css/spinner.css" type="text/css" rel="stylesheet"/>
  </head>

  <body>
    <header class="md-header">
      <nav class="md-grid md-grid__inner">
        <a class="md-header__button md-logo" href="/index.html">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
            <path
              d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z"
            ></path>
            <path
              d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z"
              style="fill-opacity: 0.5;"
            ></path>
            <path
              d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z"
            ></path>
            <path
              d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z"
              style="fill-opacity: 0.25;"
            ></path>
          </svg>
        </a>
        <div class="md-header__title">
          <div class="md-header__ellipsis">
            <div class="md-header__topic">
              <span>Jasper 2.0</span>
            </div>
          </div>
        </div>
        <div class="md-header__source">
          <a href="https://github.com/depers/jasper" class="md-source">
            <div class="md-source__icon md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                <!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.-->
                <path
                  d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"
                ></path>
              </svg>
            </div>
            <div class="md-source__repository">depers/jasper</div>
          </a>
        </div>
      </nav>
    </header>

    <div class="spinner">
      <div class="dot1"></div>
      <div class="dot2"></div>
    </div>

    <main class="md-main">
      <div class="md-main__inner md-grid">
        <div class="md-content">
          <article class="md-content__inner">
            <div class="md-typeset">
              <p class="md-content__word_small"></p>
              <p class="md-content__title"></p>
              <p class="md-content__word_date"></p>
            </div>
            <p class="md-content__con markdown-body">
            </p>
          </article>
        </div>

        <div class="md-comments">
          <div class="comments-title">评论</div>
          <div class="comment-list">
          </div>

          <div class="publish-comment">
            <div class="publish-comment-title">我要发表评论</div>
            <textarea class="comment-box"></textarea>
            <div class="publish-title">显示昵称</div>
            <input type="text" class="comment-nickname comment-input" />
            <div class="publish-title">电子邮箱</div>
            <input type="text" class="comment-email comment-input" />
            <div class="publish-title">个人网站地址</div>
            <input type="text" class="comment-personalSite comment-input" />
            <button class="comment-btn" onclick="postComment()">发表评论</button>
            <label class="error-info"></label>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="foot-bg">
        <p>Designed & Powerd by depers</p>
        <p>
          Copyright
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="width: 10px; fill: #fff"><!--! Font Awesome Pro 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M256 48a208 208 0 1 1 0 416 208 208 0 1 1 0-416zm0 464A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM199.4 312.6c-31.2-31.2-31.2-81.9 0-113.1s81.9-31.2 113.1 0c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9c-50-50-131-50-181 0s-50 131 0 181s131 50 181 0c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0c-31.2 31.2-81.9 31.2-113.1 0z"/></svg>
          2017-2023 Jasper
        </p>
        <a>陇ICP备17003451号-1</a>
      </div>
    </footer>
  </body>

<script>
    const serverUrl = "http://43.142.173.83/blog";
    var articleId; 
    $(document).ready(function(){
        // 获取请求链接中的参数
        const url = new URL(window.location.href);
        articleId = url.searchParams.get("aid");
        
        marked.setOptions({ 
          renderer: new marked.Renderer(), 
          gfm: true,  // 默认为true。允许GitHub标准的markdown
          tables: true, // 默认为true。允许支持表格语法。该选项要求 gfm 为true
          breaks: true, // 默认为false。允许回车换行。该选项要求 gfm 为true。
          pedantic: false, // 默认为false。 尽可能地兼容 markdown.pl的晦涩部分。不纠正原始模型任何的不良行为和错误。
          sanitize: false, // 默认为false。 对输出进行过滤（清理），将忽略任何已经输入的html代码（标签） smartLists 它是一个布尔值，默认为false。 使用比原生markdown更时髦的列表。 旧的列表将可能被作为pedantic的处理内容过滤掉.
          smartypants: false, // 默认为false。 使用更为时髦的标点，比如在引用语法中加入破折号
          highlight(code) { 
            return hljs.highlightAuto(code).value 
          }
        }) 

        // 隐藏内容
        $(".md-main").hide();
        requestDetail(articleId);

        // 是否展示dom主体内容
        var loadObj = {
          show: false
        };
        Object.defineProperty(loadObj, "show", {
          set: function(newValue) {
            if (newValue == true) {
              // 隐藏loading
              $(".spinner").hide();
              // 展示内容
              $(".md-main").fadeIn("300");
            }
          }
        })
    });

    function requestDetail(articleId) {
        if (articleId == "" || articleId == undefined) {
            alert("系统错误，请稍后再试！");
        }

        axios({
            method: 'get',
            url: serverUrl + '/detail/' + articleId
            })
            .catch(function (error) {
                console.log(error.toJSON());
                alert("系统错误，请稍后再试！");
            })
            .then(function (response) {
                console.log(response.data);
                console.log(response.status);
                var data = response.data.data;
                if(response.data.code == "0000") {
                    $("title").text(data.title);
                    $(".md-content__word_small").text(data.tags.join(" / "));
                    $(".md-content__title").text(data.title);
                    $(".md-content__word_date").text(data.publishDate);
                    // $(".md-content__con").html(marked.parse(data.content));
                    $(".md-content__con").html(marked.parse(data.content).replace(/<pre>/g, "<pre class='hljs'>"));
                    
                    var commentListHtml = "";
                    data.commentList.forEach(element => {
                        var commentHtml = "<div class=\"comment\">" +
                                    "<div class=\"comment-name\">" +
                                    element.nickname +
                                    "</div>" +
                                    "<div class=\"comment-content\">" +
                                    element.comment +
                                    "</div>" +
                                    "<div class=\"comment-date\">"+
                                    element.commentDate +
                                    "</div>" +
                                    "</div>";

                        commentListHtml = commentListHtml + commentHtml;
                    });
                    $(".comment-list").append(commentListHtml);
                    // 设置可以展示主体内容
                    loadObj.show = true;
                } else {
                    alert("系统错误，请稍后再试！");
                }
            });
    }

    function postComment() {
      $(".error-info").text("");
      var comment = $(".comment-box").val();
      var nickname = $(".comment-nickname").val();
      var email = $(".comment-email").val();
      var personalSite = $(".comment-personalSite").val();

      console.log("comment" + comment);
      axios({
            method: 'post',
            url: serverUrl + '/detail/comment',
            data: {
              articleId: articleId,
              nickname: nickname,
              content: comment,
              email: email,
              personalSite: personalSite
            }
          })
          .catch(function (error) {
              console.log(error.toJSON());
              alert("系统错误，请稍后再试！");
          })
          .then(function (response) {
            console.log(response.data);
            console.log(response.status);
            var data = response.data;
            var commentDate = formatDateTime(new Date(), "yyyy/MM/dd HH:mm:ss")
            if (response.data.code == "0000") {
              var commentHtml = "<div class=\"comment\">" +
                                    "<div class=\"comment-name\">" +
                                    nickname +
                                    "</div>" +
                                    "<div class=\"comment-content\">" +
                                    comment +
                                    "</div>" +
                                    "<div class=\"comment-date\">"+
                                    commentDate +
                                    "</div>" +
                                    "</div>";
              // 将评论的内容更新到dom中
              $(".comment-list").append(commentHtml);

              $(".publish-comment input").val("");
              $(".publish-comment textarea").val("");
            } else {
              $(".error-info").text(data.msg);
            }
      })
    }


    function formatDateTime(date, format) {
      const o = {
        'M+': date.getMonth() + 1, // 月份
        'd+': date.getDate(), // 日
        'h+': date.getHours() % 12 === 0 ? 12 : date.getHours() % 12, // 小时
        'H+': date.getHours(), // 小时
        'm+': date.getMinutes(), // 分
        's+': date.getSeconds(), // 秒
        'q+': Math.floor((date.getMonth() + 3) / 3), // 季度
        S: date.getMilliseconds(), // 毫秒
        a: date.getHours() < 12 ? '上午' : '下午', // 上午/下午
        A: date.getHours() < 12 ? 'AM' : 'PM', // AM/PM
      };
      if (/(y+)/.test(format)) {
        format = format.replace(RegExp.$1, (date.getFullYear() + '').substr(4 - RegExp.$1.length));
      }
      for (let k in o) {
        if (new RegExp('(' + k + ')').test(format)) {
          format = format.replace(
            RegExp.$1,
            RegExp.$1.length === 1 ? o[k] : ('00' + o[k]).substr(('' + o[k]).length)
          );
        }
      }
      return format;
    }
</script>
</html>
